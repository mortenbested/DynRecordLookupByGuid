using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace RecordLookupByGuid
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Record Lookup by Guid"),
        ExportMetadata("Description", "Search for records using a guid"),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "LightSlateGray"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MyPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new MyPluginControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MyPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}